;MODULE LOADINGS
;;==============================================================================
;; PART 01 - Load all Mockup Enviroment Modules
(load "../pact-repl-utils/init.repl")
(load "Init_Snake.repl")
(print "LOADED ALL ENV MODULES")
;;==============================================================================
;;
;;
;;
;;
;;
;;==============================================================================
(begin-tx "TESTING")
(env-gasmodel "table")(env-gaslimit 10000000)(env-gas 0)
(print "======================================================================")
(env-sigs [ { "key": "PrivateKey_AncientHodler", "caps": [] }
            { "key": "PrivateKey_Emma", "caps": [] }])

(print "===================1st TXes===============================")
;(free.DPTF.C_TransferTrueFungibleAnew "OURO-98c486052a51" "AncientHodler" "Emma" (describe-keyset "free.User003_Keyset") 2500.0)    ;;AncientHodler Key
;(free.DPTF.C_TransferTrueFungibleAnew "OURO-98c486052a51" "AncientHodler" "Lumy" (describe-keyset "free.User002_Keyset") 1500.0)    ;;AncientHodler Key

(format "AncientHodler are {} OURO" [(at "balance" (read free.DPTF.DPTF-BalancesTable "OURO-98c486052a51|AncientHodler"))])
;(format "Emma are {} OURO" [(at "balance" (read free.DPTF.DPTF-BalancesTable "OURO-98c486052a51|Emma"))])
;(format "Lumy are {} OURO" [(at "balance" (read free.DPTF.DPTF-BalancesTable "OURO-98c486052a51|Lumy"))])

(print "Coil|Curl and Vesting Test")
(format "Auryndex is in the beginning {}" [(free.DH_SC_Autostake.UR_Auryndex)])
(free.DH_SC_Autostake.C_CoilOuroboros "AncientHodler" 32000.0)
(format "Auryndex is after the first Coil {}" [(free.DH_SC_Autostake.UR_Auryndex)])
(print "======================1ST==============================")
(format "AncientHodler has {} OURO" [(free.DPTF.UR_AccountTrueFungibleSupply "OURO-98c486052a51" "AncientHodler")])
(format "AncientHodler has {} AURYN" [(free.DPTF.UR_AccountTrueFungibleSupply "AURYN-98c486052a51" "AncientHodler")])
(format "Auryndex is {}" [(free.DH_SC_Autostake.UR_Auryndex)])


(free.DH_SC_Autostake.C_FuelOuroboros "AncientHodler" 1000.0)
(free.DH_SC_Autostake.C_CoilAuryn "AncientHodler" 28000.0)
;(free.DH_SC_Autostake.C_CurlOuroboros "Emma" 100.0)

(format "AncientHodler has {} OURO" [(free.DPTF.UR_AccountTrueFungibleSupply "OURO-98c486052a51" "AncientHodler")])
(format "AncientHodler has {} AURYN" [(free.DPTF.UR_AccountTrueFungibleSupply "AURYN-98c486052a51" "AncientHodler")])
(format "AncientHodler has {} ELITE-AURYN" [(free.DPTF.UR_AccountTrueFungibleSupply "ELITEAURYN-98c486052a51" "AncientHodler")])
(format "Auryndex is {}" [(free.DH_SC_Autostake.UR_Auryndex)])


(print "======================Uncoil Tests==============================")
(format "Autostake Resident AURYN before uncoil is {}" [(free.DH_SC_Autostake.UR_ResidentAuryn)])
(format "Autostake Unbonding AURYN before uncoil is {}" [(free.DH_SC_Autostake.UR_UnbondingAuryn)])

(free.DH_SC_Autostake.C_UncoilEliteAuryn "AncientHodler" 1000.0)
(free.DH_SC_Autostake.C_UncoilEliteAuryn "AncientHodler" 2000.0)
(free.DH_SC_Autostake.C_UncoilEliteAuryn "AncientHodler" 3000.0)
(format "1]Max Elite Auryn Uncoil Amount for AncientHodler is {} when his total EA Amount is {}" 
[(free.DH_SC_Autostake.UC_MaximEliteUncoilAmount "AncientHodler") (free.DH_SC_Autostake.UC_EliteAurynzBalance "AncientHodler")])
(free.DH_SC_Autostake.C_UncoilEliteAuryn "AncientHodler" 350.0)
(format "2]Max Elite Auryn Uncoil Amount for AncientHodler is {} when his total EA Amount is {}" 
[(free.DH_SC_Autostake.UC_MaximEliteUncoilAmount "AncientHodler") (free.DH_SC_Autostake.UC_EliteAurynzBalance "AncientHodler")])
;;Make me some Vested Elite-Auryn
(free.DH_SC_Vesting.A_VestAurynVEAuryn "AncientHodler" "AncientHodler" (describe-keyset "free.User000_Keyset") 60.0 86400 86400 5)     ;;AH key
(format "3]Max Elite Auryn Uncoil Amount for AncientHodler is {}  when his total EA Amount is {}" 
[(free.DH_SC_Autostake.UC_MaximEliteUncoilAmount "AncientHodler") (free.DH_SC_Autostake.UC_EliteAurynzBalance "AncientHodler")])


;(format "AncientHodler has {} ELITEAURYN before computing" [(free.DPTF.UR_AccountTrueFungibleSupply "ELITEAURYN-98c486052a51" "AncientHodler")])
;(format "AncientHodler has {} VESTED-ELITEAURYN before computing" [(free.DPMF.UR_AccountMetaFungibleSupply "VEAURYN-98c486052a51" "AncientHodler")])
;(format "Golden Amount for AH is {} Elite-Auryn" [(free.DH_SC_Autostake.UC_GoldenEliteAurynUncoilAmount "AncientHodler")])
;;(free.DH_SC_Autostake.C_UncoilEliteAuryn "AncientHodler" 20350.0)


;(format "Autostake Resident AURYN after uncoil is {}" [(free.DH_SC_Autostake.UR_ResidentAuryn)])
;(format "Autostake Unbonding AURYN after uncoil is {}" [(free.DH_SC_Autostake.UR_UnbondingAuryn)])

(format "AncientHodler has after EA Auncoil {} ELITE-AURYN" [(free.DPTF.UR_AccountTrueFungibleSupply "ELITEAURYN-98c486052a51" "AncientHodler")])
(format "Ancient Hodler Major Tier is {}" [(free.DH_SC_Autostake.UC_MajorEliteTier "AncientHodler")])
(format "UncoilLedger for AncientHodler at P1 {}" [(at "P1" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P2 {}" [(at "P2" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P3 {}" [(at "P3" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P4 {}" [(at "P4" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P5 {}" [(at "P5" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P6 {}" [(at "P6" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P7 {}" [(at "P7" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])

(env-chain-data
    {"block-time": (time "2024-08-05T00:00:00Z")}
)

(print "======================Cull Tests==============================")
;(format "AncientHodler has {} AURYN before culling" [(free.DPTF.UR_AccountTrueFungibleSupply "AURYN-98c486052a51" "AncientHodler")])
;(format "AncientHodler has {} ELITEAURYN before culling" [(free.DPTF.UR_AccountTrueFungibleSupply "ELITEAURYN-98c486052a51" "AncientHodler")])
;(format "Autostake Unbonding AURYN before culling is {}" [(free.DH_SC_Autostake.UR_UnbondingAuryn)])
(free.DH_SC_Autostake.C_CullAuryn "AncientHodler")
;(format "AncientHodler has {} AURYN after culling" [(free.DPTF.UR_AccountTrueFungibleSupply "AURYN-98c486052a51" "AncientHodler")])
;(format "AncientHodler has {} ELITEAURYN after culling" [(free.DPTF.UR_AccountTrueFungibleSupply "ELITEAURYN-98c486052a51" "AncientHodler")])
;(format "Autostake Unbonding AURYN after culling is {}" [(free.DH_SC_Autostake.UR_UnbondingAuryn)])

(format "AncientHodler has after EA Auncoil {} ELITE-AURYN" [(free.DPTF.UR_AccountTrueFungibleSupply "ELITEAURYN-98c486052a51" "AncientHodler")])
(format "Ancient Hodler Major Tier is {}" [(free.DH_SC_Autostake.UC_MajorEliteTier "AncientHodler")])
(format "UncoilLedger for AncientHodler at P1 {}" [(at "P1" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P2 {}" [(at "P2" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P3 {}" [(at "P3" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P4 {}" [(at "P4" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P5 {}" [(at "P5" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P6 {}" [(at "P6" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P7 {}" [(at "P7" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])

(format "2]Max Elite Auryn Uncoil Amount for AncientHodler is {} when his total EA Amount is {}" 
[(free.DH_SC_Autostake.UC_MaximEliteUncoilAmount "AncientHodler") (free.DH_SC_Autostake.UC_EliteAurynzBalance "AncientHodler")])

(print "====================Last Uncoil Test")
(free.DH_SC_Autostake.C_UncoilEliteAuryn "AncientHodler" 21650.0)
(format "UncoilLedger for AncientHodler at P1 {}" [(at "P1" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P2 {}" [(at "P2" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P3 {}" [(at "P3" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P4 {}" [(at "P4" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P5 {}" [(at "P5" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P6 {}" [(at "P6" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])
(format "UncoilLedger for AncientHodler at P7 {}" [(at "P7" (read free.DH_SC_Autostake.UncoilLedger "AncientHodler"))])


;;Vesting Tests
(print "==============================================FIRST 3================================================")
;;ouro to ouro
;(free.DH_SC_Vesting.A_VestOuroVOuro "Emma" "Lumy" (describe-keyset "free.User002_Keyset") 1.0 86400 86400 2)     ;;Emma key
;(format "Lumy are {} Vested-OURO" [(at "unit" (read free.DPMF.DPMF-BalancesTable "VOURO-98c486052a51|Lumy"))])

;;auryn to auryn
;(free.DH_SC_Vesting.A_VestAurynVAuryn "AncientHodler" "Lumy" (describe-keyset "free.User002_Keyset") 17.0 86400 86400 4)     ;;AH key
;(format "Lumy are {} Vested-AURYN" [(at "unit" (read free.DPMF.DPMF-BalancesTable "VAURYN-98c486052a51|Lumy"))])

;;elite-auryn to elite-auryn
;(free.DH_SC_Vesting.A_VestEAurynVEAuryn "AncientHodler" "Lumy" (describe-keyset "free.User002_Keyset") 77.0 86400 86400 3)     ;;AH key
;(format "Lumy are {} Vested-ELITE-AURYN" [(at "unit" (read free.DPMF.DPMF-BalancesTable "VEAURYN-98c486052a51|Lumy"))])

(print "==============================================LAST 3================================================")
;;
;;ouro to auryn
;(free.DH_SC_Vesting.A_VestOuroVAuryn "AncientHodler" "Lumy" (describe-keyset "free.User002_Keyset") 100.0 86400 86400 4)
;(format "Lumy are {} Vested-Auryn" [(at "unit" (read free.DPMF.DPMF-BalancesTable "VAURYN-98c486052a51|Lumy"))])
;(print "Lumy has this total of Vested Auryn")
;(free.DPMF.UR_AccountMetaFungibleSupply "VAURYN-98c486052a51" "Lumy")

;;ouro to elite auryn
;(free.DH_SC_Vesting.A_VestOuroVEAuryn "AncientHodler" "Lumy" (describe-keyset "free.User002_Keyset") 100.0 86400 86400 4)
;(format "Lumy are {} Vested-ELITE-AURYN" [(at "unit" (read free.DPMF.DPMF-BalancesTable "VEAURYN-98c486052a51|Lumy"))])

;(print "Lumy has this total of Vested Elite Auryn")
;(free.DPMF.UR_AccountMetaFungibleSupply "VEAURYN-98c486052a51" "Lumy")

;;auryn to elite auryn
;(free.DH_SC_Vesting.A_VestAurynVEAuryn "AncientHodler" "Lumy" (describe-keyset "free.User002_Keyset") 100.0 86400 86400 4)
;(format "Lumy are {} Vested-ELITE-AURYN" [(at "unit" (read free.DPMF.DPMF-BalancesTable "VEAURYN-98c486052a51|Lumy"))])

;(print "Lumy has this total of Vested Elite Auryn in the end")
;(free.DPMF.UR_AccountMetaFungibleSupply "VEAURYN-98c486052a51" "Lumy")

;(print "Mint autostake Auryn test")
;(expect-failure "Should fail since no capability is granted" (free.DPTF.C_Mint "AURYN-98c486052a51" "Snake_Autostake" 100.0))

(print "==============================================Uncoil Check================================================")

;;(print "Auryn transfer Role Amount is")
;;(free.DPTF.U_GetTrueFungibleTransferRoleAmount "AURYN-98c486052a51")

;;(print "Elite-Auryn transfer Role Amount is")
;;(free.DPTF.U_GetTrueFungibleTransferRoleAmount "ELITEAURYN-98c486052a51")

;(free.DH_SC_Vesting.TestMetaFungible 250.0 86400 86400 2)
;(format "Lumy are {} Vested-OURO" [(at "unit" (read free.DPMF.DPMF-BalancesTable "VOURO-98c486052a51|Snake_Vesting"))])


;(format "Emma are {} OURO" [(at "balance" (read free.DPTF.DPTF-BalancesTable "OURO-98c486052a51|Emma"))])
;(format "Snake_Vesting are {} OURO" [(at "balance" (read free.DPTF.DPTF-BalancesTable "OURO-98c486052a51|Snake_Vesting"))])

(env-gas)
(commit-tx)